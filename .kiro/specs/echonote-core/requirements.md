# EchoNote 需求文档

## 产品概述

EchoNote 是一款跨平台桌面智能语音工具，专注于提供高效、精准的语音转录、翻译和日历管理功能。应用遵循本地优先（local-first）理念，确保用户数据所有权和离线可用性，同时提供可选的云服务集成。

### 核心使用场景

1. **内容创作者与记者**：将录制的采访和会议转换为可搜索、可编辑的文本
2. **跨国团队协作者**：在国际会议中实现实时转录和翻译
3. **忙碌的职场人士**：统一日历管理，自动会议录制，基于时间线的智能规划

### 技术定位

- **目标平台**：Windows (.exe) 和 macOS (.app)
- **UI 框架**：PyQt，参考 Microsoft Teams/Slack 的侧边栏导航设计
- **语音引擎**：默认使用 faster-whisper 本地引擎，参考 WhisperLiveKit 和 faster-whisper 项目实现
- **多语言支持**：中文、英文、法语
- **架构原则**：模块化、可插拔、DRY、易维护

## 功能需求

### 需求 1：批量音频文件转录

**用户故事**：作为内容创作者，我希望能够批量转换多个音频/视频文件为文本文档，以便高效处理大量录制内容而无需手动干预。

#### 验收标准

1. WHEN 用户点击"导入文件"按钮 THEN 系统应允许选择单个文件、多个文件或整个文件夹
2. WHEN 用户选择文件夹 THEN 系统应递归扫描文件夹中所有支持的音频/视频文件
3. WHEN 文件被导入 THEN 系统应将其添加到转录任务队列，并显示文件名、大小、状态（待处理/处理中/已完成/失败）
4. WHEN 用户在设置中配置并发任务数量（默认为 1） THEN 系统应同时处理不超过该数量的任务
5. WHEN 转录任务正在执行 THEN 系统应实时显示该任务的进度百分比（基于音频时长）
6. WHEN 转录进行中 THEN 系统应生成内部统一的文本格式（包含时间戳信息），支持后续转换为多种输出格式
7. WHEN 转录完成 THEN 系统应允许用户选择导出格式（.txt 纯文本、.srt 字幕、.md Markdown）并保存到指定位置
8. WHEN 转录任务完成或失败 THEN 系统应发送桌面通知，通知内容包含文件名和状态
9. IF 导入的文件格式不支持 THEN 系统应在任务列表中标记为"不支持的格式"，并在详情中列出支持的格式
10. WHEN 用户查看任务队列 THEN 系统应显示每个任务的详细信息：文件路径、音频时长、转录语言、当前状态、错误信息（如有）
11. WHEN 用户右键点击任务 THEN 系统应提供操作选项：重试、删除、查看输出文件、复制文本到剪贴板
12. WHEN 转录引擎为 faster-whisper THEN 系统应支持选择模型大小（tiny/base/small/medium/large），并在界面上显示预估的速度和准确度

### 需求 2：实时语音转录与翻译

**用户故事**：作为跨国团队协作者，我希望能够实时捕捉音频并同步转录和翻译，以便在会议中跨越语言障碍进行理解和记录。

#### 验收标准

1. WHEN 用户进入实时转录界面 THEN 系统应列出所有可用的音频输入源（物理麦克风、系统音频环回/虚拟音频设备）
2. WHEN 用户选择音频输入源 THEN 系统应显示实时音频波形和音量表，确认音频输入正常
3. WHEN 用户调整增益滑块 THEN 系统应实时调整音频输入增益，并在波形/音量表中反映变化
4. WHEN 用户点击"开始录制"按钮 THEN 系统应同时启动：(1) 原始音频录制 (2) 实时语音转录
5. WHEN 实时转录激活 THEN 系统应以流式方式显示转录文本，延迟不超过 3 秒
6. WHEN 实时转录激活 AND 用户启用翻译 THEN 系统应在转录文本下方实时显示翻译文本
7. WHEN 用户在录制过程中切换源语言或目标语言 THEN 系统应立即应用新设置，不中断录制会话
8. WHEN 录制会话结束 THEN 系统应保存原始音频文件（WAV/MP3 格式，用户可配置）到指定目录
9. WHEN 录制会话结束 THEN 系统应允许用户导出转录文本和翻译文本为独立文件（.txt/.md）
10. WHEN 录制会话结束 THEN 系统应自动在本地日历中创建一个事件记录，包含：
    - 标题：默认为"录音会话 - [开始时间]"（用户可编辑）
    - 类型：Event
    - 开始时间：录制开始时间
    - 结束时间：录制结束时间
    - 附件链接：指向录音文件和转录文本文件的本地路径
11. WHEN 实时转录使用 faster-whisper THEN 系统应采用 VAD（语音活动检测）分段音频，参考 WhisperLiveKit 的实现方式
12. WHEN 实时转录使用 faster-whisper THEN 系统应使用滑动窗口机制处理音频流，确保上下文连贯性
13. WHEN 音频输入静音超过 2 秒 THEN 系统应在界面上显示"等待语音输入..."提示
14. IF 转录引擎出错 THEN 系统应在界面上显示错误信息，但不中断录音，允许用户继续录制原始音频

### 需求 3：统一日历中心

**用户故事**：作为忙碌的职场人士，我希望拥有一个本地优先的日历系统，可选择性地与 Google 和 Outlook 日历同步，以便在保持数据控制权的同时与现有日历生态系统保持连接。

#### 验收标准

1. WHEN 用户创建新事件 THEN 系统应首先将其存储在本地 SQLite 数据库中，确保离线功能
2. WHEN 创建事件 THEN 系统应要求以下必填字段：标题、类型（Event/Task/Appointment）、开始时间、结束时间
3. WHEN 创建事件 THEN 系统应支持以下可选字段：地点、参会人员（多个，逗号分隔）、描述、提醒时间、重复规则
4. WHEN 用户点击"连接 Google 日历"或"连接 Outlook 日历" THEN 系统应启动 OAuth 2.0 授权流程
5. WHEN OAuth 授权流程启动 THEN 系统应在系统默认浏览器中打开授权页面
6. WHEN 用户完成授权 THEN 系统应安全存储 OAuth token（加密存储），并显示"已连接"状态
7. WHEN 外部日历授权成功 THEN 系统应立即执行首次同步，将外部事件下载到本地数据库
8. WHEN 外部事件同步到本地 THEN 系统应在数据库中标记这些事件为"只读"和"外部来源"（Google/Outlook）
9. WHEN 用户尝试编辑外部同步的事件 THEN 系统应显示提示："此事件来自 [Google/Outlook]，无法在本地编辑"
10. WHEN 用户创建新的本地事件 AND 已连接外部日历 THEN 系统应在创建表单中显示复选框："同步到 Google 日历" 和/或 "同步到 Outlook 日历"
11. IF 用户勾选"同步到外部日历" THEN 系统应在本地创建成功后，调用相应的 API 将事件推送到外部服务
12. IF 外部同步失败 THEN 系统应记录错误日志，显示通知，但不影响本地事件的创建
13. WHEN 用户查看日历 THEN 系统应支持月视图、周视图、日视图三种模式切换
14. WHEN 显示事件 THEN 系统应通过不同颜色或图标区分：本地事件（蓝色）、Google 事件（红色）、Outlook 事件（橙色）
15. WHEN 用户在日历界面中 THEN 系统应在统一视图中合并显示所有本地和外部同步的事件
16. WHEN 用户断开外部日历连接 THEN 系统应删除该来源的所有同步事件，但保留本地创建的事件
17. WHEN 用户断开外部日历连接 THEN 系统应安全删除存储的 OAuth token
18. WHEN 应用启动 AND 已连接外部日历 THEN 系统应在后台自动同步外部事件（每 15 分钟一次，可配置）
19. WHEN 外部同步执行 THEN 系统应使用增量同步机制，仅获取自上次同步以来的变更

### 需求 4：智能时间线与历史追溯

**用户故事**：作为管理多个会议的职场人士，我希望有一个时间线视图，既能展示即将到来的事件及其规划能力，又能快速访问过去事件的录音和转录文本，以便高效准备未来会议并快速查找历史会议资料。

#### 验收标准

1. WHEN 用户打开时间线视图 THEN 系统应显示一个垂直滚动的时间线，中间有一条清晰的"当前时间"指示线
2. WHEN 查看时间线 THEN 系统应在"当前时间"指示线下方按时间顺序显示未来事件
3. WHEN 查看时间线 THEN 系统应在"当前时间"指示线上方按时间倒序显示过去事件
4. WHEN 显示未来事件卡片 THEN 系统应包含：事件标题、时间、地点、参会人员、两个开关按钮："启用实时转录" 和 "启用会议录音"
5. WHEN 用户为未来事件启用"实时转录"或"会议录音" THEN 系统应将该配置保存到事件记录中
6. WHEN 事件开始时间到达 AND 用户已启用自动任务 THEN 系统应自动启动配置的任务（实时转录/录音）
7. WHEN 事件开始前 5 分钟 AND 用户已启用自动任务 THEN 系统应发送桌面通知："[事件标题] 即将开始，将自动启动 [转录/录音]"
8. WHEN 显示过去事件卡片 THEN 系统应包含：事件标题、时间、地点、参会人员
9. IF 过去事件关联了录音文件 THEN 系统应在卡片上显示"播放录音"图标/按钮
10. IF 过去事件关联了转录文本 THEN 系统应在卡片上显示"查看转录"图标/按钮
11. WHEN 用户点击"播放录音" THEN 系统应打开内置音频播放器播放录音文件
12. WHEN 用户点击"查看转录" THEN 系统应在新窗口或侧边栏中显示转录文本，支持复制和导出
13. WHEN 用户使用搜索功能 THEN 系统应支持按以下条件过滤：关键词（标题/描述/转录文本）、日期范围、参会人员、事件类型
14. WHEN 搜索结果显示 THEN 系统应高亮匹配的事件，并在卡片上显示匹配的关键词片段
15. WHEN 用户滚动时间线 THEN 系统应采用虚拟滚动技术，动态加载事件，确保大数据集下的流畅性能
16. WHEN 时间线加载历史事件 THEN 系统应分页加载（每次 50 个事件），向上滚动时自动加载更多

### 需求 5：设置与配置

**用户故事**：作为用户，我希望有一个集中的设置界面，可以配置所有应用功能、自定义外观和管理语言偏好，以便根据我的具体需求定制应用。

#### 验收标准

1. WHEN 用户打开设置 THEN 系统应显示分类的设置页面：转录设置、实时录制设置、日历集成、时间线、外观、语言
2. WHEN 在"转录设置"中 THEN 系统应允许配置：默认输出格式（txt/srt/md）、并发任务数量（1-5）、默认保存位置、语音识别引擎选择
3. WHEN 在"实时录制设置"中 THEN 系统应允许配置：默认音频输入源、增益级别、自动保存偏好、录音格式（WAV/MP3）、翻译引擎设置
4. WHEN 在"日历集成"中 THEN 系统应显示已连接的账户（Google/Outlook），并提供"添加账户"和"移除账户"按钮
5. WHEN 在"时间线"中 THEN 系统应允许配置：默认视图范围（显示未来/过去多少天）、通知提前时间（5/10/15 分钟）、自动启动偏好
6. WHEN 在"外观"中 THEN 系统应提供主题选择：浅色主题、深色主题、跟随系统
7. WHEN 在"语言"中 THEN 系统应支持切换：中文（简体）、English、Français
8. WHEN 用户更改语言 THEN 系统应立即更新所有 UI 文本，无需重启应用
9. WHEN 配置语音识别引擎 THEN 系统应显示可用引擎：faster-whisper（默认）、OpenAI Whisper API、Google Speech-to-Text、Azure Speech
10. IF 选择云服务引擎 THEN 系统应提供安全的 API Key 配置字段（密码输入框，不显示明文）
11. WHEN 输入 API Key THEN 系统应使用 AES-256 加密后存储在本地配置文件中
12. IF 配置了云服务引擎 THEN 系统应显示使用统计：本月已使用时长、预估费用（基于官方定价）
13. WHEN 用户修改设置 THEN 系统应验证输入（如并发数量必须为 1-5 的整数）
14. IF 输入无效 THEN 系统应显示清晰的错误提示，并阻止保存
15. WHEN 用户保存设置 THEN 系统应立即应用更改（如果需要重启，应明确提示）

### 需求 6：语音识别引擎架构

**用户故事**：作为用户，我希望能够灵活选择语音识别引擎（本地或云端），以便在隐私、成本和准确度之间找到最佳平衡。

#### 验收标准

1. WHEN 应用初始化 THEN 系统应加载 faster-whisper 作为默认本地语音识别引擎
2. WHEN 用户选择语音引擎 THEN 系统应支持可插拔架构，允许在不修改代码的情况下切换引擎
3. WHEN 使用 faster-whisper THEN 系统应在本地处理音频，无需互联网连接
4. WHEN 使用 faster-whisper THEN 系统应支持模型选择：tiny（最快）、base、small、medium、large（最准确）
5. WHEN 用户配置云引擎（OpenAI/Google/Azure） THEN 系统应要求有效的 API Key 才能启用
6. WHEN 用户添加其他本地引擎（Vosk/Coqui STT） THEN 系统应通过统一的引擎接口集成
7. WHEN 请求转录 THEN 系统应将请求路由到当前选择的引擎
8. IF 选择的引擎失败 THEN 系统应显示清晰的错误信息，并可选地建议回退选项
9. WHEN 使用云引擎 THEN 系统应跟踪 API 使用量（音频时长），用于成本估算
10. WHEN 多个引擎可用 THEN 系统应允许用户为批量转录和实时转录设置不同的引擎
11. WHEN 使用 faster-whisper 进行实时转录 THEN 系统应参考 WhisperLiveKit 的实现，使用 VAD 和滑动窗口机制
12. WHEN 使用 faster-whisper 进行批量转录 THEN 系统应参考 faster-whisper 官方示例，使用批处理模式提高效率

### 需求 7：应用打包与分发

**用户故事**：作为用户，我希望能够下载并安装 EchoNote 作为独立应用（Windows 或 macOS），以便无需复杂的设置过程或遇到安全警告即可使用。

#### 验收标准

1. WHEN 应用为 Windows 打包 THEN 系统应生成独立的 .exe 安装程序
2. WHEN 应用为 macOS 打包 THEN 系统应生成独立的 .app 应用包
3. WHEN Windows 安装程序执行 THEN 系统应安装所有必需的依赖项，无需单独安装 Python
4. WHEN macOS 应用启动 THEN 系统应运行，无需单独安装 Python
5. WHEN 应用分发 THEN 系统应包含 Windows 和 macOS 的有效代码签名，以防止安全警告
6. WHEN 应用运行 THEN 系统不应被标准杀毒软件标记为恶意软件
7. WHEN 应用安装 THEN 系统应创建适当的桌面快捷方式和开始菜单条目（Windows）或应用程序文件夹条目（macOS）
8. WHEN 应用首次启动 THEN 系统应创建必要的配置目录和数据库文件
9. WHEN 应用打包 THEN 系统应包含 faster-whisper 模型文件（至少 base 模型），或在首次运行时自动下载

### 需求 8：性能与资源管理

**用户故事**：作为与其他应用程序一起运行 EchoNote 的用户，我希望应用能够高效使用系统资源，以便在转录和录制任务期间我的计算机保持响应。

#### 验收标准

1. WHEN 批量转录运行 THEN 系统应限制 CPU 使用率不超过 80%，允许其他应用保持响应
2. WHEN 实时转录激活 THEN 系统应优先考虑低延迟，而非最大 CPU 效率
3. WHEN 多个转录任务排队 THEN 系统应按配置的并发数量顺序或并发处理，以防止资源耗尽
4. WHEN 处理大型音频文件 THEN 系统应使用流式或分块处理，避免过度内存消耗（单个文件内存占用不超过 500MB）
5. WHEN 应用空闲 THEN 系统应释放不必要的资源，最小化后台 CPU 使用（< 1%）
6. WHEN 音频录制激活 THEN 系统应高效缓冲音频数据，防止丢帧或间隙
7. IF 系统资源严重不足（可用内存 < 500MB） THEN 系统应显示警告，并可选地暂停非关键任务
   - **实现说明**: 使用 ResourceMonitor 监控系统资源，通过 pause_processing() 暂停批量转录任务
   - 当前任务继续完成，新任务暂停接受，资源恢复后自动调用 resume_processing()
   - 监控间隔：30 秒，低内存阈值：500MB，高 CPU 阈值：90%
8. WHEN 使用 faster-whisper THEN 系统应支持 GPU 加速（CUDA/CoreML），如果可用，以提高性能
   - **实现说明**: 使用 GPUDetector 自动检测 CUDA 和 CoreML 可用性
   - 默认使用 'auto' 模式自动选择最佳设备（优先级：CUDA > CoreML > CPU）
   - 用户可在设置中手动选择设备（Auto/CPU/CUDA）
   - GPU 不可用时自动回退到 CPU，不影响功能
   - 性能提升：CUDA 5-10x，CoreML（Apple Silicon）2-3x
9. WHEN 应用启动 THEN 系统应在 5 秒内完成初始化并显示主界面
   - **实现说明**: 使用 SplashScreen 显示启动进度，LazyLoader 延迟加载重型组件
   - BackgroundInitializer 在后台初始化非关键组件，StartupTimer 测量性能
   - 关键组件优先加载（配置、数据库、UI），非关键组件后台加载（调度器、翻译引擎）
   - 预期启动时间：2-3 秒到可交互界面（相比优化前的 8-10 秒提升 60-70%）
   - 需要在 main.py 中集成使用这些优化工具

### 需求 9：数据安全与隐私

**用户故事**：作为注重隐私的用户，我希望我的敏感数据（API Key、OAuth token、录音、转录文本）被安全存储和管理，以便我的信息免受未经授权的访问。

#### 验收标准

1. WHEN 存储 API Key THEN 系统应使用行业标准加密（AES-256）进行加密
2. WHEN 存储 OAuth token THEN 系统应使用行业标准加密（AES-256）进行加密
3. WHEN 用户断开外部日历连接 THEN 系统应安全删除相关的 OAuth token
4. WHEN 保存录音和转录文本 THEN 系统应将其存储在用户指定的位置，并设置适当的文件权限（仅当前用户可读写）
5. WHEN 应用访问加密数据 THEN 系统应使用与用户系统绑定的安全密钥派生
6. WHEN 应用卸载 THEN 系统应提供选项安全删除所有用户数据，包括加密凭据
7. IF 加密密钥损坏或丢失 THEN 系统应提供机制重置并重新输入凭据
8. WHEN 本地数据库存储敏感信息 THEN 系统应使用 SQLite 的加密扩展（SQLCipher）或应用层加密
9. WHEN 应用与外部 API 通信 THEN 系统应仅使用 HTTPS 连接

### 需求 10：错误处理与用户反馈

**用户故事**：作为用户，我希望在发生错误或应用处理任务时获得清晰的反馈，以便我了解正在发生的事情，并在需要时采取适当的行动。

#### 验收标准

1. WHEN 发生错误 THEN 系统应显示用户友好的错误消息，解释出了什么问题
2. WHEN 文件格式不支持 THEN 系统应清楚地指出支持的格式（如："支持的格式：MP3, WAV, M4A, MP4, AVI"）
3. WHEN 需要网络连接但不可用 THEN 系统应通知用户，并建议离线替代方案
4. WHEN 超过 API 速率限制 THEN 系统应显示限制信息和预估的重置时间
5. WHEN 长时间运行的操作正在进行 THEN 系统应显示进度指示器和预估剩余时间
6. WHEN 操作成功完成 THEN 系统应提供确认反馈（通知、状态更新或视觉指示器）
7. IF 应用遇到意外错误 THEN 系统应记录详细的错误信息用于故障排除，同时向用户显示简化的消息
8. WHEN 用户尝试无效操作 THEN 系统应阻止该操作并解释为什么无法执行
9. WHEN 转录任务失败 THEN 系统应在任务列表中显示失败原因，并提供"重试"选项
10. WHEN 外部 API 调用失败 THEN 系统应区分网络错误、认证错误和 API 错误，并提供相应的解决建议
