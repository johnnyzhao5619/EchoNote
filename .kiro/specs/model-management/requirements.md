# 模型管理功能需求文档

## 产品概述

模型管理功能是 EchoNote 的核心扩展功能，为用户提供本地 Whisper 模型的完整生命周期管理，包括模型下载、删除、版本管理等。该功能与现有的批量转录、实时录制和设置模块深度集成，确保模型选择列表始终与本地可用模型保持同步。

### 核心价值

1. **用户自主性**：用户可以根据需求和设备性能自主选择和管理模型
2. **存储优化**：用户可以删除不需要的模型，节省磁盘空间
3. **透明度**：清晰展示模型大小、性能特征和下载状态
4. **一致性**：所有使用模型的界面（批量转录、实时录制、设置）自动同步可用模型列表

### 技术参考

- **faster-whisper 项目**：https://github.com/SYSTRAN/faster-whisper
- **WhisperLiveKit 项目**：https://github.com/QuentinFuxa/WhisperLiveKit
- **Hugging Face 模型仓库**：faster-whisper 模型的标准下载源

## 功能需求

### 需求 1：模型列表展示

**用户故事**：作为用户，我希望能够查看所有可用的 Whisper 模型及其详细信息，以便了解每个模型的特性并做出选择。

#### 验收标准

1. WHEN 用户打开模型管理界面 THEN 系统应显示所有支持的 Whisper 模型列表
2. WHEN 显示模型列表 THEN 系统应包含以下模型：tiny、tiny.en、base、base.en、small、small.en、medium、medium.en、large-v1、large-v2、large-v3
3. WHEN 显示每个模型 THEN 系统应展示以下信息：
   - 模型名称（如 "base"）
   - 模型大小（如 "142 MB"）
   - 性能特征（速度：快/中/慢，准确度：低/中/高）
   - 下载状态（未下载/下载中/已下载）
   - 本地路径（如果已下载）
4. WHEN 模型已下载 THEN 系统应显示"已下载"标记和实际占用的磁盘空间
5. WHEN 模型未下载 THEN 系统应显示"下载"按钮
6. WHEN 模型正在下载 THEN 系统应显示下载进度条和百分比
7. WHEN 用户查看模型列表 THEN 系统应按模型大小从小到大排序
8. WHEN 显示英文专用模型（如 tiny.en） THEN 系统应标注"仅支持英文"
9. WHEN 显示多语言模型 THEN 系统应标注"支持多语言"

### 需求 2：模型下载

**用户故事**：作为用户，我希望能够下载所需的 Whisper 模型，并实时查看下载进度，以便根据需要扩展应用的语音识别能力。

#### 验收标准

1. WHEN 用户点击未下载模型的"下载"按钮 THEN 系统应启动模型下载任务
2. WHEN 下载任务启动 THEN 系统应显示下载进度条，初始进度为 0%
3. WHEN 下载进行中 THEN 系统应实时更新进度条和百分比（每秒至少更新一次）
4. WHEN 下载进行中 THEN 系统应显示下载速度（如 "2.5 MB/s"）和预估剩余时间（如 "剩余 30 秒"）
5. WHEN 下载完成 THEN 系统应自动验证模型文件的完整性（检查文件大小和格式）
6. WHEN 模型验证成功 THEN 系统应更新模型状态为"已下载"，并显示桌面通知
7. WHEN 模型验证失败 THEN 系统应删除不完整的文件，显示错误消息，并允许用户重新下载
8. WHEN 下载进行中 THEN 系统应提供"取消下载"按钮
9. WHEN 用户点击"取消下载" THEN 系统应停止下载，删除部分下载的文件，并恢复模型状态为"未下载"
10. WHEN 下载失败（网络错误、磁盘空间不足等） THEN 系统应显示清晰的错误消息，并提供"重试"选项
11. WHEN 多个模型同时下载 THEN 系统应按顺序下载（队列机制），避免网络拥塞
12. WHEN 下载模型 THEN 系统应使用 Hugging Face 官方镜像源，支持断点续传
13. WHEN 下载模型 THEN 系统应将模型保存到配置的模型目录（默认 `~/.echonote/models/`）
14. WHEN 下载前磁盘空间不足 THEN 系统应提前检测并警告用户，阻止下载

### 需求 3：模型删除

**用户故事**：作为用户，我希望能够删除不再需要的模型，以便释放磁盘空间并保持系统整洁。

#### 验收标准

1. WHEN 模型已下载 THEN 系统应在模型卡片上显示"删除"按钮
2. WHEN 用户点击"删除"按钮 THEN 系统应弹出确认对话框，显示模型名称和占用空间
3. WHEN 确认对话框显示 THEN 系统应包含警告信息："删除后，使用此模型的转录任务将无法执行，直到重新下载"
4. WHEN 用户确认删除 THEN 系统应从磁盘中删除模型文件和相关缓存
5. WHEN 模型删除成功 THEN 系统应更新模型状态为"未下载"，并显示通知
6. WHEN 模型删除失败（文件被占用、权限不足等） THEN 系统应显示错误消息，并保持模型状态不变
7. WHEN 模型正在被使用（转录任务进行中） THEN 系统应禁用"删除"按钮，并显示提示："模型正在使用中，无法删除"
8. WHEN 删除模型 THEN 系统应同时删除该模型的所有相关文件（模型权重、配置文件、缓存）
9. WHEN 删除模型后 THEN 系统应自动更新所有模型选择列表（批量转录、实时录制、设置）

### 需求 4：模型选择列表同步

**用户故事**：作为用户，我希望在批量转录、实时录制和设置界面中，模型选择列表始终只显示已下载的模型，以便避免选择不可用的模型导致错误。

#### 验收标准

1. WHEN 应用启动 THEN 系统应扫描模型目录，识别所有已下载的模型
2. WHEN 模型扫描完成 THEN 系统应更新内部模型注册表（包含模型名称、路径、大小）
3. WHEN 批量转录界面加载 THEN 系统应在模型选择下拉框中仅显示已下载的模型
4. WHEN 实时录制界面加载 THEN 系统应在模型选择下拉框中仅显示已下载的模型
5. WHEN 设置界面加载 THEN 系统应在 Whisper 配置部分仅显示已下载的模型
6. WHEN 用户下载新模型 THEN 系统应立即更新所有界面的模型选择列表，新模型自动出现
7. WHEN 用户删除模型 THEN 系统应立即更新所有界面的模型选择列表，删除的模型自动移除
8. WHEN 模型选择列表更新 AND 当前选中的模型被删除 THEN 系统应自动切换到默认模型（base，如果可用）
9. WHEN 没有任何模型下载 THEN 系统应在模型选择列表中显示提示："请先下载模型"，并禁用转录功能
10. WHEN 模型选择列表为空 THEN 系统应在批量转录和实时录制界面显示引导按钮："前往下载模型"
11. WHEN 用户点击"前往下载模型" THEN 系统应自动跳转到模型管理界面

### 需求 5：模型信息查询

**用户故事**：作为用户，我希望能够查看模型的详细信息和使用统计，以便了解模型的实际表现和使用情况。

#### 验收标准

1. WHEN 用户点击模型卡片 THEN 系统应展开显示模型的详细信息
2. WHEN 显示模型详细信息 THEN 系统应包含以下内容：
   - 模型完整名称（如 "Whisper Base Multilingual"）
   - 模型版本（如 "v3"）
   - 支持的语言列表（多语言模型）或"仅英文"（英文专用模型）
   - 模型文件路径
   - 实际占用磁盘空间
   - 下载日期
   - 最后使用日期
   - 使用次数统计
3. WHEN 模型未被使用过 THEN 系统应显示"尚未使用"
4. WHEN 模型已被使用 THEN 系统应显示使用次数和最后使用时间
5. WHEN 用户查看模型信息 THEN 系统应提供"在文件管理器中显示"按钮
6. WHEN 用户点击"在文件管理器中显示" THEN 系统应打开系统文件管理器并定位到模型文件

### 需求 6：模型验证与修复

**用户故事**：作为用户，我希望系统能够自动检测损坏的模型文件，并提供修复选项，以便确保模型的可用性。

#### 验收标准

1. WHEN 应用启动 THEN 系统应验证所有已下载模型的完整性
2. WHEN 验证模型 THEN 系统应检查以下内容：
   - 模型文件是否存在
   - 文件大小是否符合预期
   - 文件格式是否正确（可以被 faster-whisper 加载）
3. WHEN 模型验证失败 THEN 系统应在模型卡片上显示"损坏"标记和警告图标
4. WHEN 模型损坏 THEN 系统应提供"重新下载"按钮
5. WHEN 用户点击"重新下载" THEN 系统应删除损坏的文件，并重新下载模型
6. WHEN 模型损坏 THEN 系统应从模型选择列表中移除该模型，直到修复完成
7. WHEN 模型验证过程中发现错误 THEN 系统应记录详细的错误日志，便于故障排查

### 需求 7：模型使用统计

**用户故事**：作为用户，我希望能够查看模型的使用统计信息，以便了解哪些模型最常用，优化存储空间。

#### 验收标准

1. WHEN 批量转录任务使用某个模型 THEN 系统应记录该模型的使用次数和使用时间
2. WHEN 实时录制使用某个模型 THEN 系统应记录该模型的使用次数和使用时间
3. WHEN 用户查看模型管理界面 THEN 系统应在每个模型卡片上显示使用次数
4. WHEN 用户查看模型详细信息 THEN 系统应显示以下统计数据：
   - 总使用次数
   - 最后使用时间
   - 累计转录时长（小时）
5. WHEN 模型从未被使用 THEN 系统应显示"未使用"标记
6. WHEN 用户查看模型列表 THEN 系统应提供按使用次数排序的选项
7. WHEN 用户按使用次数排序 THEN 系统应将最常用的模型排在前面

### 需求 8：模型配置管理

**用户故事**：作为用户，我希望能够为不同的模型配置不同的参数（如计算设备、精度），以便优化性能和资源使用。

#### 验收标准

1. WHEN 用户查看已下载的模型 THEN 系统应提供"配置"按钮
2. WHEN 用户点击"配置"按钮 THEN 系统应打开模型配置对话框
3. WHEN 配置对话框显示 THEN 系统应包含以下配置项：
   - 计算设备（CPU / CUDA / Auto）
   - 计算精度（int8 / float16 / float32）
   - 是否启用 VAD 过滤（批量转录）
   - VAD 静音阈值（毫秒）
4. WHEN 用户修改配置 THEN 系统应验证配置的有效性（如 CUDA 是否可用）
5. WHEN 配置无效 THEN 系统应显示警告并阻止保存
6. WHEN 用户保存配置 THEN 系统应将配置持久化到配置文件
7. WHEN 使用模型进行转录 THEN 系统应自动应用该模型的配置
8. WHEN 用户未配置模型 THEN 系统应使用全局默认配置

### 需求 9：模型推荐

**用户故事**：作为新用户，我希望系统能够根据我的设备性能推荐合适的模型，以便快速开始使用而无需深入了解技术细节。

#### 验收标准

1. WHEN 用户首次打开模型管理界面 AND 没有任何模型下载 THEN 系统应显示推荐模型卡片
2. WHEN 显示推荐模型 THEN 系统应根据设备性能自动推荐：
   - 低性能设备（< 8GB RAM）：推荐 tiny 或 base
   - 中等性能设备（8-16GB RAM）：推荐 small 或 medium
   - 高性能设备（> 16GB RAM 或有 GPU）：推荐 medium 或 large
3. WHEN 显示推荐模型 THEN 系统应包含推荐理由（如 "根据您的设备配置，推荐使用 base 模型，平衡速度和准确度"）
4. WHEN 推荐模型卡片显示 THEN 系统应提供"一键下载推荐模型"按钮
5. WHEN 用户点击"一键下载推荐模型" THEN 系统应自动下载推荐的模型
6. WHEN 用户已下载模型 THEN 系统应隐藏推荐卡片，或提供"查看其他推荐"选项

### 需求 10：错误处理与用户反馈

**用户故事**：作为用户，我希望在模型管理过程中遇到错误时，能够获得清晰的错误信息和解决建议，以便快速解决问题。

#### 验收标准

1. WHEN 模型下载失败 THEN 系统应显示具体的错误原因（网络错误、磁盘空间不足、权限不足等）
2. WHEN 显示错误信息 THEN 系统应提供解决建议（如 "请检查网络连接" 或 "请释放至少 500MB 磁盘空间"）
3. WHEN 模型删除失败 THEN 系统应显示错误原因和解决建议
4. WHEN 模型验证失败 THEN 系统应显示损坏的具体原因（文件缺失、大小不匹配、格式错误等）
5. WHEN 模型目录不可访问 THEN 系统应显示警告，并提供"选择其他目录"选项
6. WHEN 模型下载成功 THEN 系统应发送桌面通知："[模型名称] 下载完成"
7. WHEN 模型删除成功 THEN 系统应发送桌面通知："[模型名称] 已删除"
8. WHEN 模型操作进行中 THEN 系统应禁用相关按钮，防止重复操作
9. WHEN 发生意外错误 THEN 系统应记录详细的错误日志，并显示友好的错误消息
10. WHEN 用户遇到问题 THEN 系统应提供"查看日志"按钮，方便故障排查

## 非功能需求

### 性能需求

1. 模型列表加载时间应小于 1 秒
2. 模型扫描（验证已下载模型）应在后台异步执行，不阻塞 UI
3. 模型下载应支持多线程，充分利用网络带宽
4. 模型选择列表更新应实时响应，延迟小于 100ms

### 可用性需求

1. 模型管理界面应简洁直观，新用户无需培训即可使用
2. 所有操作应提供即时反馈（进度条、通知、状态更新）
3. 错误消息应清晰易懂，避免技术术语
4. 支持键盘快捷键（如 Ctrl+D 下载选中模型）

### 兼容性需求

1. 支持 Windows 和 macOS 平台
2. 兼容 faster-whisper 的所有官方模型
3. 支持 Hugging Face 模型仓库的标准下载协议

### 安全需求

1. 模型下载应验证文件完整性（SHA256 校验）
2. 模型文件应设置适当的文件权限（仅当前用户可读写）
3. 下载过程应使用 HTTPS 协议

### 可维护性需求

1. 模型管理逻辑应与 UI 解耦，便于测试和维护
2. 模型信息应使用配置文件管理，便于添加新模型
3. 代码应遵循 DRY 原则，避免重复逻辑
