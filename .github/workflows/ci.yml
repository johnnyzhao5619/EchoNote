name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      CI: "true"

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev portaudio19-dev libpulse-dev xvfb libegl1 libgl1

      - name: Configure Qt headless mode (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          echo "QT_QPA_PLATFORM=offscreen" >> "$GITHUB_ENV"
          echo "QT_QPA_PLATFORM_PLUGIN_PATH=/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/site-packages/PySide6/Qt/plugins/platforms" >> "$GITHUB_ENV"
          echo "QT_DEBUG_PLUGINS=1" >> "$GITHUB_ENV"

      - name: Install system dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install portaudio pkg-config
          echo "HOMEBREW_PREFIX=$(brew --prefix)" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig" >> "$GITHUB_ENV"
          echo "LDFLAGS=-L$(brew --prefix)/lib" >> "$GITHUB_ENV"
          echo "CPPFLAGS=-I$(brew --prefix)/include" >> "$GITHUB_ENV"

      - name: Configure Qt headless mode (macOS)
        if: matrix.os == 'macos-latest'
        run: echo "QT_QPA_PLATFORM=offscreen" >> "$GITHUB_ENV"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Verify PySide6 installation
        run: |
          python -c "import PySide6; print(f'PySide6 version: {PySide6.__version__}')"

      - name: Detect changed Python files
        id: changed-python
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            BASE_SHA="${{ github.event.before }}"
          else
            BASE_SHA="$(git rev-parse HEAD~1)"
          fi

          if [[ -z "${BASE_SHA}" || "${BASE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA="$(git rev-list --max-parents=0 HEAD)"
          fi

          git diff --name-only "${BASE_SHA}" "${{ github.sha }}" -- '*.py' > changed_python_files.txt
          COUNT="$(wc -l < changed_python_files.txt | tr -d ' ')"
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          echo "Changed Python files: ${COUNT}"

      - name: Run code quality checks
        if: steps.changed-python.outputs.count != '0'
        shell: bash
        run: |
          set -euo pipefail
          changed_py_files=$(cat changed_python_files.txt | tr '\n' ' ')
          black --check $changed_py_files
          isort --check-only $changed_py_files
          flake8 $changed_py_files
          mypy $changed_py_files
          bandit -c pyproject.toml $changed_py_files

      - name: Skip code quality checks
        if: steps.changed-python.outputs.count == '0'
        run: echo "No changed Python files detected; skipping black/isort/flake8/mypy/bandit."

      - name: Run tests (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: xvfb-run -a pytest tests/ --cov=core --cov=engines --cov=data --cov=utils --cov=ui

      - name: Run tests (Windows/macOS)
        if: matrix.os != 'ubuntu-latest'
        run: pytest tests/ -v
